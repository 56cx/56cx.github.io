<!doctype html><html lang="zh" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="📃文章案例实践及剖析：《迄今为止最完整的DDD实践》" /><meta name="author" content="Jason.wu" /><meta property="og:locale" content="zh" /><meta name="description" content="Jason.wu’s Technology Blog." /><meta property="og:description" content="Jason.wu’s Technology Blog." /><link rel="canonical" href="https://github.com/ai-56cx/ai-56cx.github.io/posts/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5_02/" /><meta property="og:url" content="https://github.com/ai-56cx/ai-56cx.github.io/posts/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5_02/" /><meta property="og:site_name" content="Jason.wu" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-08-25T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="📃文章案例实践及剖析：《迄今为止最完整的DDD实践》" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jason.wu","url":"https://github.com/ai-56cx/"},"dateModified":"2019-08-25T00:00:00+08:00","datePublished":"2019-08-25T00:00:00+08:00","description":"Jason.wu’s Technology Blog.","headline":"📃文章案例实践及剖析：《迄今为止最完整的DDD实践》","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/ai-56cx/ai-56cx.github.io/posts/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5_02/"},"url":"https://github.com/ai-56cx/ai-56cx.github.io/posts/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5_02/"}</script><title>📃文章案例实践及剖析：《迄今为止最完整的DDD实践》 | Jason.wu</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Jason.wu"><meta name="application-name" content="Jason.wu"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/img/favicons/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">Jason.wu</a></div><div class="site-subtitle fst-italic">Life and Technology, Life Priority.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>关于</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://gitee.com/ai-56cx/" aria-label="gitee" target="_blank" rel="noopener noreferrer" > <i class="fa-solid fa-laptop-code"></i> </a> <a href="https://github.com/ai-56cx" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['ai-56cx','outlook.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>📃文章案例实践及剖析：《迄今为止最完整的DDD实践》</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..." > </span> <span id="search-cancel">取消</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>📃文章案例实践及剖析：《迄今为止最完整的DDD实践》</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1566662400" data-df="YYYY/MM/DD" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2019/08/25 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> <a href="https://github.com/ai-56cx/">Jason.wu</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="7675 字" > <em>42 分钟</em>阅读</span></div></div></div><div class="post-content"><h2 id="1️⃣-导读"><span class="me-2">1️⃣ 导读</span><a href="#1️⃣-导读" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p><a href="https://mp.weixin.qq.com/s/y6H8UG-g829o0V0EBeEwrw" target="_blank">《迄今为止最完整的DDD实践》</a>：来源于微信公众号《阿里技术》</p></blockquote><blockquote><p><a href="https://mp.weixin.qq.com/s/QRq_mnifw62LMoHey-tMiQ" target="_blank">《迄今为止最完整的DDD实践》</a>：来源于微信公众号《阿里云开发者》</p></blockquote><h2 id="2️⃣-内容"><span class="me-2">2️⃣ 内容</span><a href="#2️⃣-内容" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>导读：对于一个架构师来说，在软件开发中如何降低系统复杂度是一个永恒的挑战。</p><h3 id="一为什么需要ddd"><span class="me-2">一、为什么需要DDD</span><a href="#一为什么需要ddd" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>复杂系统设计：系统多，业务逻辑复杂，概念不清晰，有什么合适的方法帮助我们理清楚边界，逻辑和概念<li>多团队协同：边界不清晰，系统依赖复杂，语言不统一导致沟通和理解困难。有没有一种方式把业务和技术概念统一，大家用一种语言沟通。例如：航程是大家所理解的航程吗？<li>设计与实现一致性：PRD，详细设计和代码实现天差万别。有什么方法可以把业务需求快速转换为设计，同时还要保持设计与代码的一致性？<li>架构统一，可复用资产和扩展性：当前取决于开发的同学具备很好的抽象能力和高编程的技能。有什么好的方法指导我们做抽象和实现。</ul><h3 id="二ddd的价值"><span class="me-2">二、DDD的价值</span><a href="#二ddd的价值" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>边界清晰的设计方法：通过领域划分，识别哪些需求应该在哪些领域，不断拉齐团队对需求的认知，分而治之，控制规模。<li>统一语言：团队在有边界的上下文中有意识地形成对事物进行统一的描述，形成统一的概念(模型)。<li>业务领域的知识沉淀：通过反复论证和提炼模型，使得模型必须与业务的真实世界保持一致。促使知识(模型)可以很好地传递和维护。<li>面向业务建模：领域模型与数据模型分离，业务复杂度和技术复杂度分离。</ul><h3 id="三ddd架构"><span class="me-2">三、DDD架构</span><a href="#三ddd架构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="1分层架构"><span class="me-2">1、分层架构</span><a href="#1分层架构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践01.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践01.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li>用户接口层：调用应用层完成具体用户请求。包含：controller，远程调用服务等<li>应用层App：尽量简单，不包含业务规则，而只为了下一层中的领域对象做协调任务，分配工作，重点对领域层做编排完成复杂业务场景。包含：AppService，消息处理等<li>领域层Domain：负责表达业务概念和业务逻辑，领域层是系统的核心。包含：模型，值对象，域服务，事件<li>基础层：对所有上层提供技术能力，包括：数据操作，发送消息，消费消息，缓存等<li>调用关系：用户接口层-&gt;应用层-&gt;领域层-&gt;基础层<li>依赖关系：用户接口层-&gt;应用层-&gt;领域层-&gt;基础层</ul><h4 id="2六边形架构"><span class="me-2">2、六边形架构</span><a href="#2六边形架构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践02.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践02.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践03.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践03.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li>六边形架构：系统通过适配器的方式与外部交互，将应用服务于领域服务封装在系统内部<li>分层架构：它依然是分层架构，它核心改变的是依赖关系。<li>领域层依赖倒置：领域层依赖基础层倒置成基础层依赖领域层，这个简单的变化使得领域层不依赖任务层，其他层都依赖领域层，使得领域层只表达业务逻辑且稳定。</ul><h4 id="3调用链路"><span class="me-2">3、调用链路</span><a href="#3调用链路" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践04.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践04.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><h3 id="四ddd的基本概念"><span class="me-2">四、DDD的基本概念</span><a href="#四ddd的基本概念" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="1领域模型"><span class="me-2">1、领域模型</span><a href="#1领域模型" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>领域（战略）：业务范围，范围就是边界。<li>子领域：领域可大可小，我们将一个领域进行拆解形成子领域，子领域还可以进行拆解。当一个领域太大的时候需要进行细化拆解。<li>模型（战术）：基于某个业务领域识别出这个业务领域的聚合，聚合根，界限上下文，实体，值对象。</ul><h5 id="11核心域"><span class="me-2">1.1、核心域</span><a href="#11核心域" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>决定产品和公司核心竞争力的子域是核心域，它是业务成功的主要因素和公司的核心竞争力。直接对业务产生价值。</p><h5 id="12通用域"><span class="me-2">1.2、通用域</span><a href="#12通用域" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>没有太多个性化的诉求，同时被多个子域使用的通用功能子域是通用域。例如，权限，登陆等等。间接对业务产生价值。</p><h5 id="13支撑域"><span class="me-2">1.3、支撑域</span><a href="#13支撑域" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>支撑其他领域业务，具有企业特性，但不具有通用性。间接对业务产生价值。</p><h5 id="14为什么要划分核心域通用域和支撑域"><span class="me-2">1.4、为什么要划分核心域、通用域和支撑域</span><a href="#14为什么要划分核心域通用域和支撑域" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>一个业务一定有他最重要的部分，在日常做业务判断和需求优先级判断的时候可以基于这个划分来做决策。例如：一个交易相关的需求和一个配置相关的需求排优先级，很明显交易是核心域，规则是支持域。同样我们认为是支撑域或者通用域的在其他公司可能是核心域，例如权限对于我们来说是通用域，但是对于专业做权限系统的公司，这个是核心域。</p><h4 id="2限界上下文战略"><span class="me-2">2、限界上下文（战略）</span><a href="#2限界上下文战略" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>业务的边界的划分，这个边界可以是一个领域或者多个领域的集合。复杂业务需要多个域编排完成一个复杂业务流程。限界上下文可以作为微服务划分的方法。其本质还是高内聚低耦合，只是限界上下文只是站在更高的层面来进行划分。如何进行划分，我的方法是一个界限上下文必须支持一个完整的业务流程，保证这个业务流程所涉及的领域都在一个限界上下文中。</p><h4 id="3实体entity"><span class="me-2">3、实体（ENTITY）</span><a href="#3实体entity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>定义：实体有唯一的标识，有生命周期且具有延续性。例如一个交易订单，从创建订单我们会给他一个订单编号并且是唯一的这就是实体唯一标识。同时订单实体会从创建，支付，发货等过程最终走到终态这就是实体的生命周期。订单实体在这个过程中属性发生了变化，但订单还是那个订单，不会因为属性的变化而变化，这就是实体的延续性。</p><p>实体的业务形态：实体能够反映业务的真实形态，实体是从用例提取出来的。领域模型中的实体是多个属性、操作或行为的载体。</p><p>实体的代码形态：我们要保证实体代码形态与业务形态的一致性。那么实体的代码应该也有属性和行为，也就是我们说的充血模型，但实际情况下我们使用的是贫血模型。贫血模型缺点是业务逻辑分散，更像数据库模型，充血模型能够反映业务，但过重依赖数据库操作，而且复杂场景下需要编排领域服务，会导致事务过长，影响性能。所以我们使用充血模型，但行为里面只涉及业务逻辑的内存操作。</p><p>实体的运行形态：实体有唯一ID，当我们在流程中对实体属性进行修改，但ID不会变，实体还是那个实体。</p><p>实体的数据库形态：实体在映射数据库模型时，一般是一对一，也有一对多的情况。</p><h4 id="4值对象valueobject"><span class="me-2">4、值对象（VALUEOBJECT）</span><a href="#4值对象valueobject" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>定义：通过对象属性值来识别的对象，它将多个相关属性组合为一个概念整体。在 DDD 中用来描述领域的特定方面，并且是一个没有标识符的对象，叫作值对象。值对象没有唯一标识，没有生命周期，不可修改，当值对象发生改变时只能替换（例如String的实现）</p><p>值对象的业务形态：值对象是描述实体的特征，大多数情况一个实体有很多属性，一般都是平铺，这些数据进行分类和聚合后能够表达一个业务含义，方便沟通而不关注细节。</p><p>值对象的代码形态：实体的单一属性是值对象，例如：字符串，整型，枚举。多个属性的集合也是值对象，这个时候我们把这个集合设计为一个CLASS，但没有ID。例如商品实体下的航段就是一个值对象。航段是描述商品的特征，航段不需要ID，可以直接整体替换。商品为什么是一个实体，而不是描述订单特征，因为需要表达谁买了什么商品，所以我们需要知道哪一个商品，因此需要ID来标识唯一性。</p><p>我们看一下下面这段代码，person这个实体有若干个单一属性的值对象，比如Id、name等属性；同时它也包含多个属性的值对象，比如地址address。</p><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践05.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践05.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><p>值对象的运行形态：值对象创建后就不允许修改了，只能用另外一个值对象来整体替换。当我们修改地址时，从页面传入一个新的地址对象替换调用person对象的地址即可。如果我们把address设计成实体，必然存在ID，那么我们需要从页面传入的地址对象的ID与person里面的地址对像的ID进行比较，如果相同就更新，如果不同先删除数据库在新增数据。</p><p>值对象的数据库形态：有两种方式嵌入式和序列化大对象。</p><p>案例1：以属性嵌入的方式形成的人员实体对象，地址值对象直接以属性值嵌入人员实体中。</p><p>当我们只有一个地址的时候使用嵌入式比较好，如果多个地址必须有序列化大对象，同时可以支持搜索。</p><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践06.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践06.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><p>案例2：以序列化大对象的方式形成的人员实体对象，地址值对象被序列化成大对象Json串后，嵌入人员实体中。</p><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践07.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践07.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><p>支持多个地址存储，不支持搜索。</p><p>值对象的优势和局限：</p><ol><li>简化数据库设计，提升数据库操作的性能（多表新增和修改，关联表查询）。<li>虽然简化数据库设计，但是领域模型还是可以表达业务。<li>序列化的方式会使搜索实现困难（通过搜索引擎可以解决）。</ol><h4 id="5聚合和聚合根"><span class="me-2">5、聚合和聚合根</span><a href="#5聚合和聚合根" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>多个实体和值对象组成的我们叫聚合，聚合的内部一定的高内聚。这个聚合里面一定有一个实体是聚合根。</p><p>聚合与领域的关系：聚合也是范围的划分，领域也是范围的划分。领域与聚合可以是一对一，也可以是一对多的关系</p><p>聚合根的作用是保证内部的实体的一致性，对外只需要对聚合根进行操作。</p><h4 id="6限界上下文域聚合实体值对象的关系"><span class="me-2">6、限界上下文，域，聚合，实体，值对象的关系</span><a href="#6限界上下文域聚合实体值对象的关系" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>领域包含限界上下文，限界上下文包含子域，子域包含聚合，聚合包含实体和值对象</p><h4 id="7事件风暴"><span class="me-2">7、事件风暴</span><a href="#7事件风暴" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>参与者</p><p>除了领域专家，事件风暴的其他参与者可以是DDD专家、架构师、产品经理、项目经理、开发人员和测试人员等项目团队成员</p><p>事件风暴准备的材料</p><p>一面墙和一支笔。</p><p>事件风暴的关注点</p><p>在领域建模的过程中，我们需要重点关注这类业务的语言和行为。比如某些业务动作或行为（事件）是否会触发下一个业务动作，这个动作（事件）的输入和输出是什么？是谁（实体）发出的什么动作（命令），触发了这个动作（事件）…我们可以从这些暗藏的词汇中，分析出领域模型中的事件、命令和实体等领域对象。</p><p>实体执行命令产生事件。</p><p>业务场景的分析</p><p>通过业务场景和用例找出实体，命令，事件。</p><p>领域建模</p><p>领域建模时，我们会根据场景分析过程中产生的领域对象，比如命令、事件等之间关系，找出产生命令的实体，分析实体之间的依赖关系组成聚合，为聚合划定限界上下文，建立领域模型以及模型之间的依赖。领域模型利用限界上下文向上可以指导微服务设计，通过聚合向下可以指导聚合根、实体和值对象的设计。</p><h3 id="五如何建模"><span class="me-2">五、如何建模</span><a href="#五如何建模" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践08.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践08.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li>用例场景梳理：就是一句话需求，但我们需要把一些模糊的概念通过对话的方式逐步得到明确的需求，在加以提炼和抽象。<li>建模方法论：词法分析（找名词和动词），领域边界<li>模型验证</ul><h4 id="1协同单自动化分单案例"><span class="me-2">1、协同单自动化分单案例</span><a href="#1协同单自动化分单案例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><h5 id="11领域建模"><span class="me-2">1.1、领域建模</span><a href="#11领域建模" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>需求：我们需要把系统自动化失败转人工订单自动分配给小二，避免人工挑单和抢单，通过自动分配提升整体履约处理效率。</p><ul><li><p>产品小A：把需求读了一遍…….。</p><li><p>开发小B：那就是将履约单分配给个小二对吧？</p><li><p>产品小A：不对，我们还需要根据一个规则自动分单，例如退票订单分给退票的小二</p><li><p>开发小B：恩，那我们可以做一个分单规则管理。例如：新增一个退票分单规则，在里面添加一批小二工号。履约单基于自身属性去匹配分单规则并找到一个规则，然后从分单规则里面选择一个小二工号，履约单写入小二工号即可。</p></ul><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践09.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践09.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li><p>产品小A：分单规则还需要有优先级，其中小二如果上班了才分配，如果下班了就不分配。</p><li><p>开发小B：优先级没有问题，在匹配分单规则方法里面按照优先级排序即可，不影响模型。而小二就不是简单一个工号维护在分单规则中，小二有状态了。</p></ul><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践10.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践10.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li><p>产品小A：分单规则里面添加小二操作太麻烦了，例如：每次新增一个规则都要去挑人，人也不一定记得住，实际客服在管理小二的时候是按照技能组管理的。</p><li><p>开发小B：恩，懂了，那就是通过新增一个技能组管理模块来管理小二。然后在通过分单规则来配置1个技能组即可。获取一个小二工号就在技能组里面了。</p></ul><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践11.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践11.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li>开发小B：总感觉不对，因为新增一个自动化分单需求，履约单就依赖了分单规则，履约单应该是一个独立的域，分单不是履约的能力，履约单实际只需要知道处理人是谁，至于怎么分配的他不太关心。应该由分单规则基于履约单属性找匹配一个规则，然后基于这个规则找到一个小二。履约单与分单逻辑解耦。</ul><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践12.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践12.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li><p>产品小A：分单要轮流分配或者能者多劳分配，小二之前处理过的订单和航司优先分配。</p><li><p>开发小B：获取小二的逻辑越来越复杂了，实际技能组才是找小二的核心，分单规则核心是通过履约单特征得到一个规则结果(技能组ID，分单策略，特征规则)。技能组基于分单规则的结果获得小二工号。</p></ul><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践13.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践13.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li><p>产品小A：还漏了一个信息，就是履约单会被多次分配的情况，每一个履约环节都可能转人工，客服需要知道履约单被处理多次的情况</p><li><p>开发小B：那用履约单无法表达了，我们需要新增一个概念叫协同单，协同单是为了协同履约单，通过协同推进履约单的进度。</p></ul><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践14.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践14.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li><p>产品小A：协同单概念很好，小二下班后，如果没有处理完，还可以转交给别人。</p><li><p>开发小B：恩，那只需要在协同单上增加行为即可。</p></ul><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践15.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践15.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><h5 id="12领域划分"><span class="me-2">1.2、领域划分</span><a href="#12领域划分" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>沟通的过程就是推导和验证模型的过程，最后进行域的划分：</p><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践16.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践16.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><h5 id="13场景梳理"><span class="me-2">1.3、场景梳理</span><a href="#13场景梳理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>穷举所有场景，重新验证模型是否可以覆盖所有场景。</p><div class="table-wrapper"><table><thead><tr><th>场景名称<th>锁<th>场景动作<th>域<th>域服务<th>聚合根<th>方法<tbody><tr><td>创建协同单<td>无<td>1、判断关联业务单是否非法<td>协同单<td>创建协同单<br />1、问题分类是否符合条件(例如:商家用户发起自营-&gt;商家的协同单)<br />2、save<td>协同单<td>创建协同单<tr><td>分配协同单<td>协同单ID<td>分配协同单到人.<br />1、判断协同单状态(=待处理)<br />2、记录操作日志<br />3、save<td>协同单<td>分配协同单<td>协同单<td>分配协同单<tr><td>受理协同单<td>协同单ID<td>处理协同单<td>协同单<td>受理协同单<br />1.判断订单状态(=待处理/验收失败)<br />2.更改订单状态（待处理/验收失败-&gt;处理中）<br />3.记录操作日志<br />4.save<td>协同单<td>受理协同单<tr><td>转交协同单<td>协同单ID<td>转交协同单<td>协同单<td>转交协同单<br />1.判断订单状态.（=处理中、待处理）<br />2.校验转交的人是否在正确的组织下面<br />3.更改协同人值对象（同一组织下的不同人，从坐席管理域中取）<br />4.记录操作日志<br />5.save<td>协同单<td>转交协同单<tr><td>关闭协同单<td>协同单ID<td>关闭协同单<td>协同单<td>关闭协同单<br />1.判断订单状态(=处理中、待处理)<br />2.更改订单状态(关闭)<br />3.记录操作日志<br />4.save<td>协同单<td>关闭协同单<tr><td>处理协同单<td>协同单ID<td>处理协同单<td>协同单<td>处理协同单<br />1.判断订单状态(=处理中)<br />2.更改订单状态(处理中-&gt;待验收)<br />3.记录操作日志<br />4.save<td>协同单<td>处理协同单<tr><td>驳回协同单<td>协同单ID<td>驳回协同单<td>协同单<td>驳回协同单<br />1.判断订单状态(=待验收)<br />2.更改订单状态(待验收-&gt;处理中)<br />3.记录操作日志<br />4.save<td>协同单<td>驳回协同单<tr><td>完结协同单<td>协同单ID<td>完结协同单<td>协同单<td>完结协同单<br />1.判断订单状态(=待验收)<br />2.更改订单状态(待验收-&gt;已完结)<br />3.记录操作日志<br />4.save<td>协同单<td>完结协同单<tr><td>拒绝协同单<td>协同单ID<td>拒绝协同单<td>协同单<td>拒绝协同单<br />1.判断订单状态(=处理中、待处理)<br />2.更改订单状态(已拒绝)<br />3.记录操作日志<br />4.save<td>协同单<td>拒绝协同单<tr><td>催单<td>协同单ID<td>催单<td>协同单<td>催单<br />1.判断订单状态(=处理中、待处理)<br />2、修改催单值对象<br />3、记录操作日志<br />4、save<td>协同单<td>催单</table></div><h3 id="六怎么写代码"><span class="me-2">六、怎么写代码</span><a href="#六怎么写代码" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="1ddd规范"><span class="me-2">1、DDD规范</span><a href="#1ddd规范" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践17.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践17.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><p>每一层都定义了相应的接口主要目的是规范代码：</p><ul><li><p>application：CRQS模式，ApplicationCmdService是command，ApplicationQueryService是query</p><li><p>service：是领域服务规范，其中定义了DomainService，应用系统需要继承它。</p><li><p>model：是聚合根，实体，值对象的规范。</p><ul><li>Aggregate和BaseAggregate：聚合根定义<li>Entity和BaseEntity：实体定义<li>Value和BaseValue：值对象定义<li>Param和BaseParam：领域层参数定义，用作域服务，聚合根和实体的方法参数<li>Lazy：描述聚合根属性是延迟加载属性，类似与hibernate。<li>Field：实体属性，用来实现update-tracing</ul></ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="cm">/**
 * 实体属性，update-tracing
 * @param &lt;T&gt;
 */</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Changeable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">changed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">private</span> <span class="no">T</span> <span class="n">value</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nf">Field</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setValue</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">equalsValue</span><span class="o">(</span><span class="n">value</span><span class="o">)){</span>
            <span class="k">this</span><span class="o">.</span><span class="na">changed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isChanged</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">changed</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="no">T</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equalsValue</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">build</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>repository<ul><li>Repository：仓库定义<li>AggregateRepository：聚合根仓库,定义聚合根常用的存储和查询方法</ul><li><p>event：事件处理</p><li>exception：定义了不同层用的异常<ul><li>AggregateException：聚合根里面抛的异常<li>RepositoryException：基础层抛的异常<li>EventProcessException：事件处理抛的</ul></ul><h4 id="2工程结构"><span class="me-2">2、工程结构</span><a href="#2工程结构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践18.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践18.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><h5 id="21application模块"><span class="me-2">2.1、application模块</span><a href="#21application模块" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践19.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践19.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li>CRQS模式：commad和query分离。<li>重点做跨域的编排工作，无业务逻辑。</ul><h5 id="22domain模块"><span class="me-2">2.2、domain模块</span><a href="#22domain模块" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践20.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践20.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><ul><li>域服务,聚合根，值对象，领域参数，仓库定义</ul><h5 id="23infrastructurre模块"><span class="me-2">2.3、infrastructurre模块</span><a href="#23infrastructurre模块" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践21.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践21.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><p>所有技术代码在这一层。mybatis，redis，mq，job，opensearch代码都在这里实现，domain通过依赖倒置不依赖这些技术代码和JAR。</p><h5 id="24client模块"><span class="me-2">2.4、client模块</span><a href="#24client模块" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>对外提供服务</p><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践22.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践22.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><h5 id="25model模块"><span class="me-2">2.5、model模块</span><a href="#25model模块" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>内外都要用的共享对象</p><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践23.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践23.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><h4 id="3代码示例"><span class="me-2">3、代码示例</span><a href="#3代码示例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><h5 id="31application示例"><span class="me-2">3.1、application示例</span><a href="#31application示例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CaseAppFacade</span> <span class="kd">extends</span> <span class="nc">ApplicationCmdService</span> <span class="o">{</span>
    <span class="cm">/**
     * 接手协同单
     * @param handleCaseDto
     * @return
     */</span>
    <span class="nc">ResultDO</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">HandleCaseDto</span> <span class="n">handleCaseDto</span><span class="o">);</span>

<span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CaseAppImpl</span> <span class="kd">implements</span> <span class="nc">CaseAppFacade</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">CaseService</span> <span class="n">caseService</span><span class="o">;</span><span class="c1">//域服务</span>
    <span class="nd">@Resource</span>
    <span class="nc">CaseAssembler</span> <span class="n">caseAssembler</span><span class="o">;</span><span class="c1">//DTO转Param</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ResultDO</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">HandleCaseDto</span> <span class="n">handleCaseDto</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ResultDO</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">resultDO</span> <span class="o">=</span> <span class="n">caseService</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">caseAssembler</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">handleCaseDto</span><span class="o">));</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">resultDO</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">pushMsg</span><span class="o">(</span><span class="n">handleCaseDto</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
                <span class="k">return</span> <span class="nc">ResultDO</span><span class="o">.</span><span class="na">buildSuccessResult</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nc">ResultDO</span><span class="o">.</span><span class="na">buildFailResult</span><span class="o">(</span><span class="n">resultDO</span><span class="o">.</span><span class="na">getMsg</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">ResultDO</span><span class="o">.</span><span class="na">buildFailResult</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>mapstruct：VO,DTO,PARAM,DO,PO转换非常方便，代码量大大减少。<li>CaseAppImpl.handle调用域服务caseService.handle。</ul><h5 id="32domainservice示例"><span class="me-2">3.2、domainService示例</span><a href="#32domainservice示例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CaseService</span> <span class="kd">extends</span> <span class="nc">DomainService</span> <span class="o">{</span>
    <span class="cm">/**
     * 接手协同单
     *
     * @param handleParam
     * @return
     */</span>
    <span class="nc">ResultDO</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">HandleParam</span> <span class="n">handleParam</span><span class="o">);</span>
    
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CaseServiceImpl</span> <span class="kd">implements</span> <span class="nc">CaseService</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
  <span class="kd">private</span> <span class="nc">CoordinationRepository</span> <span class="n">coordinationRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ResultDO</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">HandleParam</span> <span class="n">handleParam</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SyncLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">coordinationRepository</span><span class="o">.</span><span class="na">syncLock</span><span class="o">(</span><span class="n">handleParam</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nc">ResultDO</span><span class="o">.</span><span class="na">buildFailResult</span><span class="o">(</span><span class="s">"协同单handle加锁失败"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">CaseAggregate</span> <span class="n">caseAggregate</span> <span class="o">=</span> <span class="n">coordinationRepository</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">handleParam</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="n">caseAggregate</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">handleParam</span><span class="o">.</span><span class="na">getFollowerValue</span><span class="o">());</span>
            <span class="n">coordinationRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">caseAggregate</span><span class="o">);</span>
            <span class="k">return</span> <span class="nc">ResultDO</span><span class="o">.</span><span class="na">buildSuccessResult</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RepositoryException</span> <span class="o">|</span> <span class="nc">AggregateException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="no">LOG</span><span class="o">.</span><span class="na">error4Tracer</span><span class="o">(</span><span class="nc">OpLogConstant</span><span class="o">.</span><span class="na">traceId</span><span class="o">(</span><span class="n">handleParam</span><span class="o">.</span><span class="na">getId</span><span class="o">()),</span> <span class="n">e</span><span class="o">,</span> <span class="s">"协同单handle异常"</span><span class="o">);</span>
            <span class="k">return</span> <span class="nc">ResultDO</span><span class="o">.</span><span class="na">buildFailResult</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">coordinationRepository</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>领域层不依赖基础层的实现：coordinationRepository只是接口，在领域层定义好，由基础层依赖领域层实现这个接口。<li>业务逻辑和技术解耦：域服务这层通过调用coordinationRepository和聚合根将业务逻辑和技术解耦。<li>聚合根的方法无副作用：聚合根的方法只对聚合根内部实体属性的改变，不做持久化动作，可反复测试。<li>模型与数据分离：<ul><li>改变模型：caseAggregate.handle(handleParam.getFollowerValue())。<li>改变数据：coordinationRepository.save(caseAggregate)；事务是在save方法上。</ul></ul><h5 id="33aggregateentity示例"><span class="me-2">3.3、Aggregate,Entity示例</span><a href="#33aggregateentity示例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CaseAggregate</span> <span class="kd">extends</span> <span class="nc">BaseAggregate</span> <span class="kd">implements</span> <span class="nc">NoticeMsgBuilder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CaseEntity</span> <span class="n">caseEntity</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">CaseAggregate</span><span class="o">(</span><span class="nc">CaseEntity</span> <span class="n">caseEntity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">caseEntity</span> <span class="o">=</span> <span class="n">caseEntity</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 接手协同单
     * @param followerValue
     * @return
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">FollowerValue</span> <span class="n">followerValue</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AggregateException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">caseEntity</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">followerValue</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CaseEntity</span> <span class="kd">extends</span> <span class="nc">BaseEntity</span> <span class="o">{</span>
    <span class="cm">/**
     * 创建时间
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">Date</span><span class="o">&gt;</span> <span class="n">gmtCreate</span><span class="o">;</span>
    <span class="cm">/**
     * 修改时间
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">Date</span><span class="o">&gt;</span> <span class="n">gmtModified</span><span class="o">;</span>
    <span class="cm">/**
     * 问题分类
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">caseType</span><span class="o">;</span>
    <span class="cm">/**
     * 是否需要支付
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">needPayFlag</span><span class="o">;</span>
    <span class="cm">/**
     * 是否需要自动验收通过协同单
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">autoAcceptCoordinationFlag</span><span class="o">;</span>
    <span class="cm">/**
     * 发起协同人值对象
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">CreatorValue</span><span class="o">&gt;</span> <span class="n">creatorValue</span><span class="o">;</span>
    <span class="cm">/**
     * 跟进人
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">FollowerValue</span><span class="o">&gt;</span> <span class="n">followerValue</span><span class="o">;</span>
    <span class="cm">/**
     * 状态
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">CaseStatusEnum</span><span class="o">&gt;</span> <span class="n">status</span><span class="o">;</span>
    <span class="cm">/**
     * 关联协同单id
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">relatedCaseId</span><span class="o">;</span>
    <span class="cm">/**
     * 关联协同单类型
     * @see 读配置 com.alitrip.agent.business.flight.common.model.dataobject.CoordinationCaseTypeDO
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">relatedBizType</span><span class="o">;</span>

    <span class="cm">/**
     * 支付状态
     */</span>
    <span class="kd">private</span> <span class="nc">Field</span><span class="o">&lt;</span><span class="nc">PayStatusEnum</span><span class="o">&gt;</span> <span class="n">payStatus</span><span class="o">;</span>
    <span class="n">省略</span><span class="o">....</span>

    <span class="kd">public</span> <span class="nc">CaseFeatureValue</span> <span class="nf">getCaseFeatureValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">caseFeatureValue</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">isCaseFeatureValueChanged</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">caseFeatureValue</span><span class="o">.</span><span class="na">isChanged</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCaseFeatureValue</span><span class="o">(</span><span class="nc">CaseFeatureValue</span> <span class="n">caseFeatureValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">caseFeatureValue</span> <span class="o">=</span> <span class="n">set</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">caseFeatureValue</span><span class="o">,</span> <span class="n">caseFeatureValue</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">isPayStatusChanged</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">payStatus</span><span class="o">.</span><span class="na">isChanged</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">isGmtCreateChanged</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">gmtCreate</span><span class="o">.</span><span class="na">isChanged</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">isGmtModifiedChanged</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">gmtModified</span><span class="o">.</span><span class="na">isChanged</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">isCaseTypeChanged</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">caseType</span><span class="o">.</span><span class="na">isChanged</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">省略</span><span class="o">....</span>

   
    <span class="cm">/**
    * 接手
    */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">FollowerValue</span> <span class="n">followerValue</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AggregateException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isWaitProcess</span><span class="o">()||</span><span class="n">isAppointProcess</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">setFollowerValue</span><span class="o">(</span><span class="n">followerValue</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">PROCESSING</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">setGmtModified</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
            <span class="n">initCaseRecordValue</span><span class="o">(</span><span class="nc">CaseActionNameEnum</span><span class="o">.</span><span class="na">HANDLE</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">followerValue</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">throwStatusAggregateException</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">省略</span><span class="o">....</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>充血模型VS贫血模型：<ul><li>充血模型：表达能力强，代码高内聚，领域内封闭，聚合根内部结构对外不可见，通过聚合根的方法访问，适合复杂企业业务逻辑。<li>贫血模型：业务复杂之后，逻辑散落到大量方法中。</ul><li>规范大于技巧：DDD架构可以避免引入一些其他概念，系统只有域，域服务，聚合根，实体，值对象，事件来构建系统。</ul><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践24.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践24.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践25.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践25.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><p>聚合根的reconProcess的方法的业务逻辑被reconHandler和reconRiskHandler处理，必然这些handler要访问聚合根里面的实体的属性，那么逻辑就会散落。修改后：</p><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践26.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践26.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><p>没有引入其他概念，都是在聚合根里面组织实体完成具体业务逻辑，去掉了handler这种技术语言。</p><ul><li>聚合根和实体定义的方法是具备单一原则，复用性原则与使用场景无关，例如：不能定义手工创建协调单和系统自动创建协同单，应该定义创建协同单。<li>Update-tracing：handle方法修改属性后，然后调用 coordinationRepository.save(caseAggregate)，我们只能全量属性更新。Update-tracing是监控实体的变更。 Entiy定义属性通过Field进行包装实现属性的变更状态记录，结合mapstruct转换PO实现Update-tracing。</ul><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践27.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践27.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><p>修改了mapstruct生成转换代码的源码，修改后生成的代码：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">if</span><span class="o">(</span><span class="n">caseEntity</span><span class="o">.</span><span class="na">isAppended</span><span class="o">()</span> <span class="o">||</span> <span class="n">caseEntity</span><span class="o">.</span><span class="na">isCaseTypeChanged</span><span class="o">()){</span>
    <span class="n">casePO</span><span class="o">.</span><span class="na">setCaseType</span><span class="o">(</span> <span class="n">caseEntity</span><span class="o">.</span><span class="na">getCaseType</span><span class="o">()</span> <span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>当属性被改变后就转换到po中，这样就可以实现修改后的字段更新。</p><ul><li>idea的get和set方法自动生成：由于使用field包装，需要自定义get和set生成代码。</ul><p><a href="/assets/article/202306/20230630迄今为止最完整的DDD实践28.png" class="popup img-link "><img data-src="/assets/article/202306/20230630迄今为止最完整的DDD实践28.png" alt="迄今为止最完整的DDD实践" class="lazyload" data-proofer-ignore></a> <em>迄今为止最完整的DDD实践</em></p><h5 id="34repository示例"><span class="me-2">3.4、Repository示例</span><a href="#34repository示例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre><td class="rouge-code"><pre>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CoordinationRepository</span> <span class="kd">extends</span> <span class="nc">Repository</span> <span class="o">{</span>  
  <span class="cm">/**
     * 保存/更新
     * @param aggregate
     * @throws RepositoryException
     */</span>
   <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">CaseAggregate</span> <span class="n">aggregate</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RepositoryException</span><span class="o">;</span>
<span class="o">}</span>
<span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CoordinationRepositoryImpl</span> <span class="kd">implements</span> <span class="nc">CoordinationRepository</span> <span class="o">{</span>
  <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">CaseAggregate</span> <span class="n">aggregate</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RepositoryException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            
            <span class="c1">//聚合根转PO，update-tracing技术</span>
            <span class="nc">CasePO</span> <span class="n">casePO</span> <span class="o">=</span> <span class="n">caseConverter</span><span class="o">.</span><span class="na">toCasePO</span><span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">());</span>
            <span class="nc">CasePO</span> <span class="n">oldCasePO</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">isAppended</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">casePOMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">casePO</span><span class="o">);</span>
                <span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">setId</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">oldCasePO</span> <span class="o">=</span> <span class="n">casePOMapper</span><span class="o">.</span><span class="na">selectByPrimaryKey</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
                <span class="n">casePOMapper</span><span class="o">.</span><span class="na">updateByPrimaryKeySelective</span><span class="o">(</span><span class="n">casePO</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// 发送协同单状态改变消息</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">FINISH</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getStatus</span><span class="o">())</span>
                <span class="o">||</span> <span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">WAIT_DISTRIBUTION</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getStatus</span><span class="o">())</span>
                <span class="o">||</span> <span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">PROCESSING</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getStatus</span><span class="o">())</span>
                <span class="o">||</span> <span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">APPOINT_PROCESS</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getStatus</span><span class="o">())</span>
                <span class="o">||</span> <span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">WAIT_PROCESS</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getStatus</span><span class="o">())</span>
                <span class="o">||</span> <span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">CLOSE</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getStatus</span><span class="o">())</span>
                <span class="o">||</span> <span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">REJECT</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getStatus</span><span class="o">())</span>
                <span class="o">||</span> <span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">PENDING_ACCEPTANCE</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()))</span> <span class="o">{</span>

                <span class="nc">FollowerDto</span> <span class="n">followerDto</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FollowerDto</span><span class="o">();</span>
                <span class="n">followerDto</span><span class="o">.</span><span class="na">setCurrentFollowerId</span><span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">getFollowerValue</span><span class="o">().</span><span class="na">getCurrentFollowerId</span><span class="o">());</span>
                <span class="n">followerDto</span><span class="o">.</span><span class="na">setCurrentFollowerGroupId</span><span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">getFollowerValue</span><span class="o">().</span><span class="na">getCurrentFollowerGroupId</span><span class="o">());</span>
                <span class="n">followerDto</span><span class="o">.</span><span class="na">setCurrentFollowerType</span><span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">getFollowerValue</span><span class="o">().</span><span class="na">getCurrentFollowerType</span><span class="o">());</span>
                <span class="n">followerDto</span><span class="o">.</span><span class="na">setCurrentFollowerName</span><span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">getFollowerValue</span><span class="o">().</span><span class="na">getCurrentFollowerName</span><span class="o">());</span>
                <span class="c1">//拒绝和关闭都使用CLOSE</span>
                <span class="nc">String</span> <span class="n">tag</span> <span class="o">=</span> <span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">codeOf</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()).</span><span class="na">name</span><span class="o">();</span>
                <span class="k">if</span><span class="o">(</span><span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">REJECT</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">tag</span><span class="o">)){</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="nc">CaseStatusEnum</span><span class="o">.</span><span class="na">CLOSE</span><span class="o">.</span><span class="na">name</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">statusChangeProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="nc">CaseStatusChangeEvent</span><span class="o">.</span><span class="na">build</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">setFollowerDto</span><span class="o">(</span><span class="n">followerDto</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">getStatus</span><span class="o">().</span><span class="na">getCode</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">setCaseType</span><span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">getCaseType</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">setOldStatus</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">oldCasePO</span> <span class="o">?</span> <span class="n">oldCasePO</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setAppointTime</span><span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">getAppointTime</span><span class="o">()),</span> <span class="o">(</span><span class="n">tag</span><span class="o">));</span>
            <span class="o">}</span>

            <span class="c1">// 操作日志</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">getCaseRecordValue</span><span class="o">()))</span> <span class="o">{</span>
                <span class="nc">CaseRecordValue</span> <span class="n">caseRecordValue</span> <span class="o">=</span> <span class="nc">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">(</span><span class="n">aggregate</span><span class="o">.</span><span class="na">getCase</span><span class="o">().</span><span class="na">getCaseRecordValue</span><span class="o">()).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                <span class="n">caseRecordValue</span><span class="o">.</span><span class="na">setCaseId</span><span class="o">(</span><span class="n">casePO</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
                <span class="n">recordPOMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">caseConverter</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">caseRecordValue</span><span class="o">));</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RepositoryException</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>CoordinationRepository接口定义在领域层。<li>CoordinationRepositoryImpl实现在基础层:数据库操作都是基于聚合根操作，保证聚合根里面的实体强一致性。</ul><h3 id="七最后结束语"><span class="me-2">七、最后结束语</span><a href="#七最后结束语" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>好的模型，可以沉淀组织资产，不好的模型，逐渐成为负债。<li>功能才是表象，模型才是内在。<li>建模过程是不断猜想与反驳的过程。<li>演化观点是建模过程的基本心智模式。</ul><h2 id="3️⃣-剖析"><span class="me-2">3️⃣ 剖析</span><a href="#3️⃣-剖析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/%E7%BC%96%E7%A8%8B/'>编程</a>, <a href='/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/'>软件工程</a>, <a href='/categories/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/'>领域驱动设计</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" class="post-tag no-text-decoration" >软件工程</a> <a href="/tags/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1-ddd/" class="post-tag no-text-decoration" >领域驱动设计(DDD)</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted me-1">分享</span> <span class="share-icons"> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="分享链接" data-title-succeed="链接已复制！" > <i class="fa-fw fas fa-link pe-none"></i> </button> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/">📂数据库：组织和存储数据的系统</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/java%E6%A1%86%E6%9E%B6/">Java框架</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF/">前端技术</a> <a class="post-tag btn btn-outline-primary" href="/tags/java%E5%9F%BA%E7%A1%80/">Java基础</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%A7%BB%E5%8A%A8%E8%AE%BE%E5%A4%87/">移动设备</a> <a class="post-tag btn btn-outline-primary" href="/tags/python%E5%9F%BA%E7%A1%80/">Python基础</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/">版本控制</a> <a class="post-tag btn btn-outline-primary" href="/tags/java%E6%8A%80%E5%B7%A7/">Java技巧</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E5%B7%A5%E4%BD%9C%E6%B5%81/">工作流</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">Git</a> <a class="post-tag btn btn-outline-primary" href="/tags/spring%E7%94%9F%E6%80%81/">Spring生态</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">文章内容</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> 相关文章</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1566662400" data-df="YYYY/MM/DD" > 2019/08/25 </em><h4 class="pt-0 my-2" data-toc-skip>📂领域驱动设计（Domain Driven Design，缩写DDD）：软件代码的结构及语言需符合业务领域中的习惯用法</h4><div class="text-muted small"><p> 1️⃣ 导读 百度百科(DDD)      一种通过将软件实现与核心业务概念的演进紧密相连从而实现复杂需求的软件开发方法。 维基百科(领域驱动设计)      领域驱动设计（英语：domain-driven design，缩写 DDD）是软件代码的结构及语言（类别名称、类方法、类变量）需符合业务领域中的习惯用法。例如处理租赁业务的软件，其类型可以命名为LoanAppli...</p></div></div></a></div><div class="col"> <a href="/posts/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5_01/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1566662400" data-df="YYYY/MM/DD" > 2019/08/25 </em><h4 class="pt-0 my-2" data-toc-skip>📃文章案例实践及剖析：《领域驱动设计DDD｜从入门到代码实践》</h4><div class="text-muted small"><p> 1️⃣ 导读 《领域驱动设计DDD｜从入门到代码实践》：来源于微信公众号《阿里云开发者》 2️⃣ 内容 导读：本文希望能够通过总结过去自己对领域建模的一点粗浅经验给需要的同学能有些许启发，少走弯路。 3️⃣ 剖析</p></div></div></a></div><div class="col"> <a href="/posts/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5_03/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1566662400" data-df="YYYY/MM/DD" > 2019/08/25 </em><h4 class="pt-0 my-2" data-toc-skip>📃文章案例实践及剖析：《高德信息业务DDD实战 - 聊聊用领域重构胶水代码》</h4><div class="text-muted small"><p> 1️⃣ 导读 《高德信息业务DDD实战 - 聊聊用领域重构胶水代码》：来源于微信公众号《阿里云开发者》 2️⃣ 内容 导读：本文主要记录了高德信息业务DDD实战中如何用领域重构胶水代码。 一、背景 团队简介：高德信息业务us团队主要承接聚合下游服务（搜索、推荐、广告、离线、商服、营销等）面向端、车机等上游，持续、稳定的提供多行业、多品类、多场景的结构化数据服务。 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5_01/" class="btn btn-outline-primary" prompt="上一篇" ><p>📃文章案例实践及剖析：《领域驱动设计DDD｜从入门到代码实践》</p></a> <a href="/posts/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5_03/" class="btn btn-outline-primary" prompt="下一篇" ><p>📃文章案例实践及剖析：《高德信息业务DDD实战 - 聊聊用领域重构胶水代码》</p></a></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/java%E6%A1%86%E6%9E%B6/">Java框架</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF/">前端技术</a> <a class="post-tag btn btn-outline-primary" href="/tags/java%E5%9F%BA%E7%A1%80/">Java基础</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%A7%BB%E5%8A%A8%E8%AE%BE%E5%A4%87/">移动设备</a> <a class="post-tag btn btn-outline-primary" href="/tags/python%E5%9F%BA%E7%A1%80/">Python基础</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/">版本控制</a> <a class="post-tag btn btn-outline-primary" href="/tags/java%E6%8A%80%E5%B7%A7/">Java技巧</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E5%B7%A5%E4%BD%9C%E6%B5%81/">工作流</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">Git</a> <a class="post-tag btn btn-outline-primary" href="/tags/spring%E7%94%9F%E6%80%81/">Spring生态</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>本站采用 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 主题 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a></p><p>© 2023 <a href="https://github.com/ai-56cx">Jason.wu</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。" >保留部分权利。</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">发现新版本的内容。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/zh.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
